---
title: Percent of pupils registered in 1st grade elementary school in 2014 from the population
output:
  html_document:
    number_sections: true
    toc: true
    fig_width: 8
    fig_height: 6
    theme: cosmo
    highlight: tango
    code_folding: show
---
```{r setup, include=FALSE}
library(jsonlite)
library(rgdal)
library(leaflet)
require(plotrix)
library(plyr)
```


# Introduction


In a previously developed [Kernel](https://www.kaggle.com/gpreda/esar-2014-exploratory-analysis), 
we explored the data in the pupils file, focusing on migration from rural to urban areas,
type of education, how the disabled pupils have access in rural and urban area to other
educational options than the main-stream, traditional education system and also relationship
between ethnic apartenence, disabled status and orphan or institutionalized status for the
pupils registered in our data file.  


In this Kernel we will use the data in pupils, schools and 2 geolocation files to represent on a *leaflet* 
map the percent of population (values from last census of 2011) that registered as pupils
in 1st class in elementary school in 2014. To calculate this percent, we will merge all 
4 sources of data, using as join factors the SIRUES code (for join between pupils data
and schools data) and the county name (for join between the schools+pupils data 
and geojeson data and between the two geojson data). As the county names are written 
differently in the 3 data files, we will use a function for matching the county names with
fuzzy match based on Levenshtein distance between the compared strings. 

# Function matchingNames

The function 'matchingNames' is used to fuzzy match between Romanian counties names from
data files where diferent encoding or writing of these names makes simple matching not 
effective

```{r matching_names}
# Matching names using: https://www.r-bloggers.com/fuzzy-string-matching-a-survival-skill-to-tackle-unstructured-information/
#match using Levenshtein distance between the compared strings 
matchingNames <- function(source1, source2) {
  # To make sure we are dealing with charts
  source1<-as.character(source1)
  source2<-as.character(source2)
  
  # It creates a matrix with the Standard Levenshtein distance between the name fields of both sources
  dist.name<-adist(source1,source2, partial = FALSE, ignore.case = FALSE)
 
  # We now take the pairs with the minimum distance
  min.name<-apply(dist.name, 1, min)
  
  match.s1.s2<-NULL  
  for(i in 1:nrow(dist.name))
  {
    s2.i<-match(min.name[i],dist.name[i,])
    s1.i<-i
    match.s1.s2<-rbind(data.frame(s2.i=s2.i,s1.i=s1.i,
                                  s2name=source2[s2.i], s1name=source1[s1.i], 
                                  adist=min.name[i]),match.s1.s2)
  }
  
  mapi<-c(1:nrow(dist.name))
  for(j in 1:nrow(dist.name))
  {
    mapi[match.s1.s2$s1.i[j]] = match.s1.s2$s2.i[j]
  }
  return(mapi)
}
```

# Read pupils data

From the pupils data we keep only the sex and SIRUES codes. SIRUES codes are used
to uniquely identify the schools.

```{r read_pupils_info}
#read data about pupils registering in 1st grade in 2014
#the data contains SIRUES code (unique for each school) - we will use this code to merge pupil's data with schools data
raw.data <- read.csv("../input/elementary_school_registration_2014.csv")
#perform some data cleansing, reducing some irrelevant columns and renaming columns for clarity
# 'SIRUES' is an unique code attributed to each school
pupils<-cbind(raw.data[,c(2,10)])
column.names.pupils<-c("sex","SIRUES")
colnames(pupils)<-column.names.pupils
```

# Read schools data

From the schools data we keep only few dimmensions: the county name, the SIRUES code 
(this code will be used to match the information from pupils data file), the school type 
and the school category

```{r read_schools_data}
#read data about schools
#'judet' is an administrative unit in Romania, like 'county' in US
raw.SIRUES <- read.csv("../input/school_network.csv")
#perform some data cleansing, reducing some irrelevant columns and renaming columns for clarity
schools<-cbind(raw.SIRUES[,c(2,3,4,6,7)])
column.names.schools<-c("judet","name","SIRUES","school_type","school_category")
colnames(schools)<-column.names.schools
```
# Merge pupils and school information

Merging the pupils information with school information is done using the SIRUES code.

```{r merge_pupils_schools}

#merge schools and pupils data on SIRUES common code
pupils.schools <- merge(pupils, schools, by="SIRUES")
```

# Read geojson information

There are two geojson data files; the first is used for rendering; the second is used
for extracting the census information. While the first has a reduced number of points
whilst the countie boundaries are represented with a good-enough accuracy for our 
purpose, the seconf file have a too large number of contour points and will be used just
to extract the census data. 

```{r geojson_data}
#geoJSON used for rendering, has lower number of points
rgeojson <- readOGR("../input/romania.geojson", layer="OGRGeoJSON")

#geoJSON used for retrieving population information from census
geojson <- readLines("../input/ro_judete_poligon.geojson", warn = FALSE, encoding = "UTF-8") %>%
  paste(collapse = "\n") %>%
  fromJSON(simplifyVector = FALSE)
```

# List with census information

We create a list with census information for all census years, with information for 
every county ('judet'). We then extract the population for last census (2011). This
will be used to calculate the percent from each county population that is registered
in 2014 for 1st year in elementary school.

```{r census_population}
# Gather population for all counties ('judet')
poplist <- lapply(geojson$features, function(feat) {
  c(as.character(feat$properties$name),as.integer(feat$properties$pop1948),as.integer(feat$properties$pop1956),as.integer(feat$properties$pop1977), as.integer(feat$properties$pop1992), as.integer(feat$properties$pop2002),as.integer(feat$properties$pop2011))
})
census.years<-c("1948", "1956","1977", "1992", "2001", "2011")
pop <- matrix(unlist(poplist), nrow = 42, ncol = 7, byrow = TRUE)
colnames(pop) <- c("judet",census.years)

population2011 <- pop[,c(1,7)]
```

# Join the pupils and schools data with geojson data

We join the data from pupils and schools with the geojson data using a fuzzy match
with *matchingNames function*. Join column is the county name. As the name is not 
standardized (in one version diacritics are used, while in other not, some versions 
uses hyphen while others not) only the fuzzy match allows a fully-automated processing
of the data.

```{r fuzzy_match_for_join}
#get pupils registered per each county
pupils_registered_per_county <- count(pupils.schools, "judet")
#match the counties with 'judet' (ordering as in the geojson)
pupilsCounty <- pupils_registered_per_county[matchingNames(rgeojson$name,as.character(pupils_registered_per_county$judet)),]

populationCounty <-population2011[matchingNames(rgeojson$name,as.character(population2011[,1])),]
```

# Compute the percent of population registered for 1st grade elementary school

The percent of the population registered for 1st grade elementary school in 2014 is
approximated, from pupils data and census data, as the report of number of pupils
registered per county in 2014 and last population estimate during the census of 2011. 
All the pupils registering in 2014 were already born in 2011.

```{r prepare_percent}
percentPupilsCounty <- pupilsCounty$freq / as.integer(populationCounty[,2])
# Color by number of pupils admited
displayPercent = round(percentPupilsCounty * 100,2)

pal <- colorBin("Greens", displayPercent, bins = 8, na.color = "Red")
```

# Interactive map

The interactive map shows each county with:

* the number of pupils registering 1st grade in 2014
* the population in 2011
* percentage of pupils in 1st grade (2014) from the total population (2011 census)
 

The map shows large regional variations from the counties in Moldova to the counties in 
South of Romania.

Hint: click on the map to see detailed information on each county.

```{r}
#initialize popup
countyPopup <- paste0("<h3>Judet (County):&nbsp<font color=\"red\">",pupilsCounty$judet,"</font></h3>",
                      "Pupils registered for 1st grade, 2014:&nbsp<b><font color=\"red\">",pupilsCounty$freq,"</font></b>",
                      "<br><br></strong>Population, 2011:&nbsp<b><font color=\"red\">",populationCounty[,2],"</font></b>",
                      "<br><br></strong>Percent pupils in 1st grade (2014)<br>from population (2011 census):&nbsp<b><font color=\"red\">",displayPercent,"%</font></b>")

#prepare leaflet
leaflet(data = rgeojson) %>% 
  addTiles() %>%
  setView(25.6, 45.6, 7) %>% 
  addPolygons(fillColor = ~pal(displayPercent), 
              fillOpacity = 0.9, 
              color = "#7700BB", 
              weight = 1, 
              popup = countyPopup) %>%
  addLegend("topright", pal = pal, 
            values = c(min(displayPercent),
                       max(displayPercent)),
            title = "Percent pupils registered<br>in 1st grade (2014)<br> from population (2011 census)",
            labFormat = labelFormat(suffix = "%"),
            opacity = 1
  )
```



Thank you for reading this Kernel. I will appreciate your comments and suggestions.




